import{r as e,b as a}from"./react-vendor-BvX3KSce.js";import{c as t,z as r,B as o,F as s,s as n,b as i,i as l}from"./index-B3vA9Pia.js";import{u as c,j as d,b as u,c as g,d as h}from"./query-vendor-BeCrZh-n.js";function m({title:a,titleId:t,...r},o){return e.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:o,"aria-labelledby":t},r),a?e.createElement("title",{id:t},a):null,e.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"}))}const y=e.forwardRef(m);function f({title:a,titleId:t,...r},o){return e.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:o,"aria-labelledby":t},r),a?e.createElement("title",{id:t},a):null,e.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"}))}const p=e.forwardRef(f),w=t("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]);
/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const b={}.REACT_APP_UNSPLASH_ACCESS_KEY;if(!b)throw new Error("Missing Unsplash API key");const v=new class{baseURL="https://api.unsplash.com";headers={Authorization:`Client-ID ${b}`,"Accept-Version":"v1"};async searchPhotos(e){const a=new URLSearchParams({query:e.query,page:String(e.page||1),per_page:String(e.per_page||20),...e.order_by&&{order_by:e.order_by},...e.color&&{color:e.color},...e.orientation&&{orientation:e.orientation}}),t=await fetch(`${this.baseURL}/search/photos?${a}`,{headers:this.headers});if(!t.ok){if(403===t.status)throw new Error("API rate limit exceeded. Please try again later.");throw new Error(`Search failed: ${t.statusText}`)}return t.json()}async getRandomPhotos(e=20){const a=await fetch(`${this.baseURL}/photos/random?count=${e}`,{headers:this.headers});if(!a.ok)throw new Error(`Failed to fetch random photos: ${a.statusText}`);return a.json()}async getPhoto(e){const a=await fetch(`${this.baseURL}/photos/${e}`,{headers:this.headers});if(!a.ok)throw new Error(`Failed to fetch photo: ${a.statusText}`);return a.json()}async downloadPhoto(e){await fetch(e,{headers:this.headers})}},x=()=>{const[a,t]=e.useState(""),[o,s]=e.useState({}),n=e.useRef(null),{data:i,isLoading:l,error:d,fetchNextPage:u,hasNextPage:g,isFetchingNextPage:h,refetch:m}=c({queryKey:["images","search",a,o],queryFn:async({pageParam:e=1,signal:t})=>{if(!a.trim()){const e=await v.getRandomPhotos(20);return{results:e,total:e.length,total_pages:1}}return v.searchPhotos({query:a,page:e,per_page:20,...o})},getNextPageParam:(e,a)=>{if(0!==e.results.length)return a.length<e.total_pages?a.length+1:void 0},enabled:!0,staleTime:3e5,gcTime:6e5,retry:(e,a)=>!a.message.includes("rate limit")&&!a.message.includes("403")&&e<2}),y=i?.pages.flatMap(e=>e.results)||[],f=g,p=e.useCallback((e,a)=>{n.current&&n.current.abort(),t(e),a&&s(a)},[]),w=e.useCallback(()=>{g&&!h&&u()},[g,h,u]),b=e.useCallback(()=>{t(""),s({})},[]);return d&&r.error(d.message||"Failed to search images"),{images:y,isLoading:l||h,error:d?{code:"SEARCH_ERROR",message:d.message||"Search failed",timestamp:(new Date).toISOString(),recoverable:!0,details:d}:null,hasMore:f,search:p,loadMore:w,clearResults:b}},k=()=>e.useCallback(async e=>{try{e.links?.download_location&&await v.downloadPhoto(e.links.download_location)}catch(a){console.error("Failed to track download:",a)}},[]),E=({title:e,description:t,actionText:r,onAction:n,icon:i="search",className:l=""})=>d.jsxs("div",{className:`flex flex-col items-center justify-center p-8 text-center ${l}`,children:[d.jsx("div",{className:"mb-4",children:(()=>{if(a.isValidElement(i))return i;const e="w-12 h-12 text-gray-400 dark:text-gray-500";switch(i){case"search":default:return d.jsx(s,{className:e});case"photo":return d.jsx(y,{className:e})}})()}),d.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2",children:e}),d.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6 max-w-md",children:t}),r&&n&&d.jsx(o,{onClick:n,variant:"primary",children:r})]});var S={};const C=new class{baseURL=S.REACT_APP_SUPABASE_URL||"/api";apiKey=S.REACT_APP_SUPABASE_ANON_KEY;async generateDescription(e,a){try{const t=await fetch(`${this.baseURL}/functions/v1/ai-description`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(e),signal:a});if(!t.ok)throw new Error(`Supabase function failed: ${t.statusText}`);if(!t.body)throw new Error("No response stream available");return t.body}catch(t){console.warn("Supabase function failed, falling back to direct API:",t);const r=await fetch(`${this.baseURL}/generate-description`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify(e),signal:a});if(!r.ok)throw new Error(`Generation failed: ${r.statusText}`);if(!r.body)throw new Error("No response stream available");return r.body}}getCacheKey(e,a,t,r){return`desc_${e}_${a}_${t?btoa(t).slice(0,10):""}_${r?.length?btoa(r.join(",")).slice(0,10):""}`}getCachedDescription(e){try{const a=localStorage.getItem(e);if(!a)return null;const t=JSON.parse(a);return Date.now()-t.timestamp>864e5?(localStorage.removeItem(e),null):t}catch{return null}}setCachedDescription(e,a){try{localStorage.setItem(e,JSON.stringify(a))}catch(t){console.warn("Failed to cache description:",t)}}},N=()=>{const[a,t]=e.useState(""),[o,s]=e.useState([]),[n,i]=e.useState(!1),[l,c]=e.useState(null),[d,u]=e.useState(0),[g,h]=e.useState(0),[m,y]=e.useState(0),[f,p]=e.useState(0),w=e.useRef(null),b=e.useRef(null),v=e.useRef(0),{isOnline:x}=function(){const[a,t]=e.useState(navigator.onLine),[r,o]=e.useState(null),[s,n]=e.useState(!1);return e.useEffect(()=>{(window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone)&&n(!0);const e=()=>{t(!0),console.log("App is online")},a=()=>{t(!1),console.log("App is offline")},r=e=>{e.preventDefault(),console.log("PWA install prompt available"),o(e)},s=()=>{console.log("PWA was installed"),n(!0),o(null)};return window.addEventListener("online",e),window.addEventListener("offline",a),window.addEventListener("beforeinstallprompt",r),window.addEventListener("appinstalled",s),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",a),window.removeEventListener("beforeinstallprompt",r),window.removeEventListener("appinstalled",s)}},[]),{isOnline:a,isOffline:!a,isInstallable:!!r&&!s,installPrompt:r,canInstall:!!r,install:async()=>{if(!r)throw new Error("Install prompt not available");try{await r.prompt(),"accepted"===(await r.userChoice).outcome?console.log("User accepted PWA install"):console.log("User dismissed PWA install"),o(null)}catch(l){throw console.error("Error installing PWA:",l),l}}}}(),[k,E]=function(a,t,r={}){const{serialize:o=JSON.stringify,deserialize:s=JSON.parse}=r,[n,i]=e.useState(()=>{try{const e=window.localStorage.getItem(a);return e?s(e):t}catch(l){return console.warn(`Error reading localStorage key "${a}":`,l),t}}),c=e.useCallback(e=>{try{const t=e instanceof Function?e(n):e;i(t),window.localStorage.setItem(a,o(t)),window.dispatchEvent(new CustomEvent("local-storage-change",{detail:{key:a,value:t}}))}catch(l){console.error(`Error setting localStorage key "${a}":`,l)}},[a,o,n]),d=e.useCallback(()=>{try{window.localStorage.removeItem(a),i(t),window.dispatchEvent(new CustomEvent("local-storage-change",{detail:{key:a,value:null}}))}catch(l){console.error(`Error removing localStorage key "${a}":`,l)}},[a,t]);return e.useEffect(()=>{const e=e=>{if(e.key===a&&null!==e.newValue)try{i(s(e.newValue))}catch(l){console.warn(`Error deserializing localStorage value for key "${a}":`,l)}},r=e=>{e.detail.key===a&&i(e.detail.value??t)};return window.addEventListener("storage",e),window.addEventListener("local-storage-change",r),()=>{window.removeEventListener("storage",e),window.removeEventListener("local-storage-change",r)}},[a,s,t]),[n,c,d]}("ai-descriptions",[]),S=e.useCallback(async(e,a,o={})=>{const{context:n,focusAreas:l,vocabularyLevel:d=3,forceRefresh:g=!1}=o;if(b.current&&b.current.abort(),!g){const o=C.getCacheKey(e,a,n,l),i=C.getCachedDescription(o);if(i)return t(i.description),s(i.vocabulary),u(i.description.split(" ").length),h(0),y(100),void r.success("Loaded cached description")}t(""),s([]),c(null),i(!0),y(0),u(0),h(0),v.current=Date.now(),b.current=new AbortController;try{if(!x)throw new Error("No internet connection. Please check your network and try again.");const r=`https://source.unsplash.com/${e}`,o=(await C.generateDescription({imageId:e,imageUrl:r,style:a,language:"en",includeVocabulary:!0,context:n,focusAreas:l,vocabularyLevel:d},b.current.signal)).getReader();w.current=o;const c=new TextDecoder;let g="",f="",p=[];try{for(;;){const{done:r,value:d}=await o.read();if(r)break;if(b.current?.signal.aborted)break;g+=c.decode(d,{stream:!0});const w=g.split("\n");g=w.pop()||"";for(const o of w)if(o.startsWith("data: ")){const r=o.slice(6);if("[DONE]"===r){i(!1),y(100),h(Date.now()-v.current);const t=C.getCacheKey(e,a,n,l);return void C.setCachedDescription(t,{imageId:e,style:a,description:f,vocabulary:p,timestamp:Date.now(),context:n,focusAreas:l})}try{const e=JSON.parse(r);switch(e.type){case"content":if(e.content){f+=e.content,t(f),u(f.split(" ").length);const a=Math.min(90,f.length/1e3*100);y(a)}break;case"vocabulary":e.vocabulary&&(p.push(e.vocabulary),s([...p]));break;case"metadata":e.metadata&&(u(e.metadata.tokenCount),h(e.metadata.processingTime));break;case"error":if(e.error)throw new Error(e.error)}}catch(m){r.trim()&&!r.includes("error")&&(f+=r,t(f),u(f.split(" ").length))}}}}finally{o.releaseLock(),w.current=null}}catch(k){if("AbortError"===k.name||b.current?.signal.aborted)t(e=>e+"\n\n[Generation cancelled]"),y(0);else{console.error("Generation error:",k);const t=k.message||"Failed to generate description";if(c({code:"GENERATION_ERROR",message:t,timestamp:(new Date).toISOString(),recoverable:!0,details:k}),r.error(t),f<3&&t.includes("network"))return void setTimeout(()=>{p(e=>e+1),S(e,a,o)},1e3*Math.pow(2,f))}}finally{i(!1),b.current=null}},[x,f]),N=e.useCallback(()=>{b.current&&b.current.abort(),w.current&&(w.current.cancel(),w.current=null),i(!1),y(0),r.info("Generation cancelled")},[]),A=e.useCallback(()=>{Object.keys(localStorage).filter(e=>e.startsWith("desc_")).forEach(e=>localStorage.removeItem(e)),E([]),r.success("Description cache cleared")},[E]),R=e.useCallback(()=>{const e=Object.keys(localStorage).filter(e=>e.startsWith("desc_")),a=[];return e.forEach(e=>{try{const t=JSON.parse(localStorage.getItem(e)||"");t&&t.timestamp&&a.push(t)}catch{localStorage.removeItem(e)}}),a.sort((e,a)=>a.timestamp-e.timestamp)},[]);return e.useEffect(()=>()=>{b.current&&b.current.abort(),w.current&&w.current.cancel()},[]),e.useEffect(()=>{n||l||!a||p(0)},[n,l,a]),{description:a,vocabulary:o,isGenerating:n,error:l,tokenCount:d,processingTime:g,progress:m,retryCount:f,generate:S,cancel:N,clearCache:A,getCachedDescriptions:R}};const A=new class{async getVocabularyWords(e,a={}){let t=n.from("vocabulary_words").select("*").eq("user_id",e).order("created_at",{ascending:!1});void 0!==a.learned&&(t=t.eq("learned",a.learned)),a.difficulty&&a.difficulty.length>0&&(t=t.in("difficulty_level",a.difficulty)),a.language&&(t=t.eq("language",a.language)),a.search&&(t=t.or(`word.ilike.%${a.search}%,definition.ilike.%${a.search}%`));const{data:r,error:o}=await t;if(o)throw new Error(`Failed to fetch vocabulary: ${o.message}`);return r||[]}async addVocabularyWord(e,a){const{data:t,error:r}=await n.from("vocabulary_words").insert([{...a,user_id:e}]).select().single();if(r)throw new Error(`Failed to add vocabulary word: ${r.message}`);return t}async updateVocabularyWord(e,a){const{data:t,error:r}=await n.from("vocabulary_words").update(a).eq("id",e).select().single();if(r)throw new Error(`Failed to update vocabulary word: ${r.message}`);return t}async deleteVocabularyWord(e){const{error:a}=await n.from("vocabulary_words").delete().eq("id",e);if(a)throw new Error(`Failed to delete vocabulary word: ${a.message}`)}async exportVocabulary(e,a){const t=await this.getVocabularyWords(e);return"csv"===a?this.exportToCSV(t):this.exportToAnki(t)}exportToCSV(e){return[["Word","Definition","Translation","Language","Difficulty","Context","Learned","Review Count"],...e.map(e=>[e.word,e.definition,e.translation||"",e.language,e.difficulty_level.toString(),e.context,e.learned?"Yes":"No",e.review_count.toString()])].map(e=>e.map(e=>`"${e.replace(/"/g,'""')}"`).join(",")).join("\n")}exportToAnki(e){return e.map(e=>[e.word,e.definition,e.translation||"",e.context,`Difficulty: ${e.difficulty_level}`].join("\t")).join("\n")}},R=(a={})=>{const t=u(),[o,s]=e.useState(null);React.useEffect(()=>{(async()=>{const{data:{user:e}}=await n.auth.getUser();s(e?.id||null)})();const{data:{subscription:e}}=n.auth.onAuthStateChange((e,a)=>{s(a?.user?.id||null)});return()=>e.unsubscribe()},[]);const{data:i=[],isLoading:l,error:c,refetch:d}=g({queryKey:["vocabulary",o,a],queryFn:()=>{if(!o)throw new Error("User not authenticated");return A.getVocabularyWords(o,a)},enabled:!!o,staleTime:3e5,gcTime:6e5}),m=h({mutationFn:e=>{if(!o)throw new Error("User not authenticated");return A.addVocabularyWord(o,e)},onSuccess:e=>{t.setQueryData(["vocabulary",o,a],a=>[e,...a||[]]),r.success(`Added "${e.word}" to vocabulary`)},onError:e=>{r.error(e.message)}}),y=h({mutationFn:({id:e,updates:a})=>A.updateVocabularyWord(e,a),onSuccess:e=>{t.setQueryData(["vocabulary",o,a],a=>a?.map(a=>a.id===e.id?e:a)||[]),r.success("Vocabulary word updated")},onError:e=>{r.error(e.message)}}),f=h({mutationFn:A.deleteVocabularyWord,onSuccess:(e,s)=>{t.setQueryData(["vocabulary",o,a],e=>e?.filter(e=>e.id!==s)||[]),r.success("Vocabulary word deleted")},onError:e=>{r.error(e.message)}}),p=h({mutationFn:e=>{if(!o)throw new Error("User not authenticated");return A.exportVocabulary(o,e)},onSuccess:(e,a)=>{const t=new Blob([e],{type:"csv"===a?"text/csv":"text/plain"}),o=URL.createObjectURL(t),s=document.createElement("a");s.href=o,s.download=`vocabulary.${a}`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o),r.success(`Vocabulary exported as ${a.toUpperCase()}`)},onError:e=>{r.error(e.message)}}),w=e.useCallback(async e=>m.mutateAsync(e),[m]),b=e.useCallback(async(e,a)=>y.mutateAsync({id:e,updates:a}),[y]),v=e.useCallback(async e=>f.mutateAsync(e),[f]),x=e.useCallback(async e=>p.mutateAsync(e),[p]);return{words:i,isLoading:l||!o,error:c?{code:"VOCABULARY_ERROR",message:c.message,timestamp:(new Date).toISOString(),recoverable:!0,details:c}:null,addWord:w,updateWord:b,deleteWord:v,exportWords:x}},L=l("rounded-lg border bg-card text-card-foreground transition-all duration-200",{variants:{variant:{default:"bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800 shadow-sm",elevated:"bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800 shadow-lg hover:shadow-xl",outlined:"bg-transparent border-2 border-gray-300 dark:border-gray-600",ghost:"bg-transparent border-0 shadow-none",filled:"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700"},size:{sm:"p-3",md:"p-4",lg:"p-6",xl:"p-8"},interactive:{true:"cursor-pointer hover:shadow-md active:scale-[0.98] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2",false:""}},defaultVariants:{variant:"default",size:"md",interactive:!1}}),_=e.forwardRef(({className:e,variant:a,size:t,interactive:r,as:o="div",loading:s=!1,disabled:n=!1,children:l,...c},u)=>d.jsx(o,{className:i(L({variant:a,size:t,interactive:r,className:e}),s&&"pointer-events-none opacity-60",n&&"pointer-events-none opacity-50"),ref:u,tabIndex:r?0:void 0,role:r?"button":void 0,"aria-disabled":n,...c,children:s?d.jsxs("div",{className:"space-y-3",children:[d.jsx("div",{className:"animate-pulse bg-gray-200 dark:bg-gray-700 h-4 rounded w-3/4"}),d.jsx("div",{className:"animate-pulse bg-gray-200 dark:bg-gray-700 h-4 rounded w-1/2"}),d.jsx("div",{className:"animate-pulse bg-gray-200 dark:bg-gray-700 h-4 rounded w-5/6"})]}):l}));_.displayName="Card";e.forwardRef(({className:e,...a},t)=>d.jsx("div",{ref:t,className:i("flex flex-col space-y-1.5 pb-4",e),...a})).displayName="CardHeader";e.forwardRef(({className:e,...a},t)=>d.jsx("h3",{ref:t,className:i("text-lg font-semibold leading-none tracking-tight text-gray-900 dark:text-white",e),...a})).displayName="CardTitle";e.forwardRef(({className:e,...a},t)=>d.jsx("p",{ref:t,className:i("text-sm text-gray-600 dark:text-gray-400",e),...a})).displayName="CardDescription";e.forwardRef(({className:e,...a},t)=>d.jsx("div",{ref:t,className:i("flex-1",e),...a})).displayName="CardContent";e.forwardRef(({className:e,...a},t)=>d.jsx("div",{ref:t,className:i("flex items-center pt-4",e),...a})).displayName="CardFooter";export{_ as C,E,p as F,N as a,R as b,x as c,w as d,k as u};
